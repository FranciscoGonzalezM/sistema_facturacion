{% extends 'core/base.html' %}
{% block title %}Facturación{% endblock %}
{% load static %}

{% block content %}
<!-- Contenedor principal con fondo azul claro y altura mínima -->
<div class="container py-3" style="background-color:#e6f2ff; min-height:600px;">
  
  <!-- Modal para selección de productos con buscador -->
  <div class="modal fade" id="modalProductos" tabindex="-1" aria-labelledby="modalProductosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalProductosLabel">Seleccionar Productos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar producto...">
          </div>
          <div class="table-responsive" style="max-height:400px; overflow-y:auto;">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Moneda</th>  <!-- Nueva columna -->
                  <th>Stock</th>
                  <th>IVA</th>
                  <th>Código Barras</th>
                  <th>Acción</th>
                </tr>
              <tbody id="listaProductos">
  {% for producto in productos %}
  <tr data-id="{{ producto.id }}" data-nombre="{{ producto.nombre }}" 
      data-precio="{{ producto.precio }}" data-stock="{{ producto.stock }}" 
      data-moneda="{{ producto.moneda.codigo }}"
      data-moneda-simbolo="{{ producto.moneda.simbolo }}"  <!-- Asegúrate que esto funcione -->
      data-codigo="{{ producto.codigo_qr|default:'' }}"
      data-barra="{% firstof producto.codigos.first.codigo_barra producto.codigo_barra|default:'' %}">
    <td>{{ producto.id }}</td>
    <td>{{ producto.nombre }}</td>
    <td class="text-end">{{ producto.moneda.simbolo }}{{ producto.precio|floatformat:2 }}</td>
    <td class="text-center">
      <span class="badge {% if producto.moneda.principal %}bg-success{% else %}bg-info{% endif %}">
        {{ producto.moneda.codigo }}
      </span>
    </td>
    <td class="text-center">{{ producto.stock }}</td>
    <td class="text-center">
      {% if producto.iva %}
      <span class="badge bg-success">Sí</span>
      {% else %}
      <span class="badge bg-secondary">No</span>
      {% endif %}
    </td>
    <td class="text-center">{% firstof producto.codigos.first.codigo_barra producto.codigo_barra|default:'N/A' %}</td>
    <td class="text-center">
      <button class="btn btn-sm btn-primary btn-agregar">Agregar</button>
    </td>
  </tr>
  {% endfor %}
</tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para procesar pago -->
  <div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalPagoLabel">Procesar Pago</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Selector de método de pago -->
          <div class="mb-3">
            <label class="form-label fw-bold">Método de Pago</label>
            <select id="metodoPago" class="form-select" onchange="cambiarMetodoPago()">
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta de Crédito/Débito</option>
              <option value="credito">Crédito</option>
            </select>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <h5>Resumen de la Factura</h5>
              <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Subtotal:</span>
                      <span id="modal-subtotal">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Descuento:</span>
                      <span id="modal-descuento">0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>I.V.A:</span>
                      <span id="modal-iva">0.00</span>
                    </div>
                  <hr>
                  <div class="d-flex justify-content-between mb-2 fs-5 fw-bold">
                    <span>Total a pagar:</span>
                    <span id="modal-total">0.00</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6" id="panelPago">
              <!-- Panel de efectivo (por defecto) -->
              <div id="panelEfectivo">
                <h5>Información de Pago</h5>
                <div class="mb-3">
                  <label for="monto-recibido" class="form-label" id="label-monto-recibido">Monto Recibido</label>
                  <input type="number" class="form-control form-control-lg" id="monto-recibido" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="mb-3">
                  <label class="form-label">Vuelto</label>
                  <div class="payment-display fs-4 fw-bold" id="vuelto">0.00</div>
                </div>
              </div>
              <!-- Panel de crédito (oculto inicialmente) -->
              <div id="panelCredito" style="display:none;">
                <h5>Venta a Crédito</h5>
                <div class="mb-3">
                  <label class="form-label">Días de Crédito</label>
                  <input type="number" class="form-control" id="dias-credito" placeholder="Ej: 30">
                </div>
                <div class="mb-3">
                  <label class="form-label">Observaciones</label>
                  <textarea class="form-control" id="obs-credito" rows="2"></textarea>
                </div>
              </div>
              <!-- Panel de tarjeta (oculto inicialmente) -->
              <div id="panelTarjeta" style="display:none;">
                <h5>Pago con Tarjeta</h5>
                <div class="mb-3">
                  <label class="form-label">Datos de la Tarjeta</label>
                  <div id="card-element" class="p-3 border rounded bg-white">
                    <!-- Stripe Elements se insertará aquí -->
                  </div>
                </div>
                <div id="card-errors" class="alert alert-danger" role="alert" style="display:none;"></div>
                <div class="text-center">
                  <img src="https://logos-world.net/wp-content/uploads/2020/09/Visa-Logo.png" height="30" class="me-2">
                  <img src="https://logos-world.net/wp-content/uploads/2020/04/Mastercard-Logo.png" height="30" class="me-2">
                  <img src="https://logos-download.com/wp-content/uploads/2016/10/American_Express_logo_logotype.png" height="30">
                </div>
              </div>
              
              <div class="d-grid gap-2 mt-3">
                <button class="btn btn-success btn-lg" id="btn-procesar-pago">
                  <i class="fas fa-check-circle me-2"></i> Procesar Pago
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Encabezado con título y reloj actualizable -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-primary fw-bold">FACTURACIÓN</h4>
    <div class="text-end">
      <small class="text-muted">Usuario: <strong>{{ request.user.username }}</strong></small>
      <br>
      <small id="clock" class="badge bg-primary text-white px-2"></small>
    </div>
  </div>

  <!-- Formulario principal de facturación con campos ocultos -->
  <form id="facturaForm" method="post" action="{% url 'facturas:facturar' %}" novalidate>
    {% csrf_token %}
    <input type="hidden" name="productos_json" id="productosJson">
    <input type="hidden" name="total_factura" id="totalFacturaHidden">
    <input type="hidden" name="confirmado" id="confirmado" value="false">
    <input type="hidden" name="monto_recibido" id="montoRecibidoHidden">
    <input type="hidden" name="vuelto" id="vueltoHidden">
    <input type="hidden" name="metodo_pago" id="metodo_pago" value="efectivo">
    <input type="hidden" name="id_transaccion" id="id_transaccion" value="">
    <input type="hidden" name="estado_pago" id="estado_pago" value="pendiente">
    <input type="hidden" name="ultimos_digitos" id="ultimos_digitos" value="">
    <input type="hidden" name="tipo_tarjeta" id="tipo_tarjeta" value="">
  <input type="hidden" name="moneda" id="monedaHidden" value="">
    
    <!-- Sección de datos de factura (número, fecha, tipo) -->
    <div class="row gy-2 align-items-center mb-3">
      <div class="col-md-2">
        <label class="form-label fw-bold">Factura No.</label>
        <input type="text" class="form-control fw-bold text-danger" name="numero_factura" value="{{ numero_factura|default:'000001' }}" readonly>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold">Fecha</label>
        <input type="date" name="fecha" class="form-control fw-bold text-danger" value="{{ fecha|date:'Y-m-d' }}" required>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">Cliente</label>
        <select name="cliente" class="form-select" required>
            <option value="">Seleccionar cliente...</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
            {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label fw-bold">Tipo Venta</label>
        <select name="tipo_venta" class="form-select" required>
          <option value="contado" selected>VENTA DE CONTADO</option>
          <option value="credito">CRÉDITO</option>
        </select>
      </div>
      <div class="col-md-4">
        <div class="row g-1">
            <div class="col-3">
                <button type="button" class="btn btn-outline-primary w-100 btn-sm" 
                        data-bs-toggle="modal" data-bs-target="#modalProductos"
                        title="Agregar producto">
                    F5
                </button>
            </div>
            <div class="col-3">
                <button type="button" class="btn btn-outline-danger w-100 btn-sm" 
                        onclick="borrarSeleccionados()"
                        title="Borrar selección">
                    F6
                </button>
            </div>
            <div class="col-3">
                <button type="button" class="btn btn-success w-100 btn-sm" 
                        onclick="mostrarModalPago()"
                        title="Confirmar factura">
                    F7
                </button>
            </div>
            <div class="col-3">
                <button type="button" class="btn btn-outline-warning w-100 btn-sm" 
                        onclick="cancelarFactura()"
                        title="Cancelar factura">
                    F8
                </button>
            </div>
        </div>
        <div class="row g-1 mt-1">
            <div class="col-3">
                <small class="text-muted d-block text-center">Agregar</small>
            </div>
            <div class="col-3">
                <small class="text-muted d-block text-center">Borrar</small>
            </div>
            <div class="col-3">
                <small class="text-muted d-block text-center">Confirmar</small>
            </div>
            <div class="col-3">
                <small class="text-muted d-block text-center">Cancelar</small>
            </div>
        </div>
      </div>
    </div>

    <!-- Campo de entrada para escanear código o ingresar ID manual -->
    <div class="mb-3 position-relative">
      <input type="text" id="codigoEscaneado" class="form-control" placeholder="Escanee código de barras o ingrese ID..." autofocus>
      <small class="text-muted position-absolute bottom-0 end-0 mb-1 me-2">Presione Enter o espere 1 segundo</small>
    </div>

    <!-- Tabla de productos agregados a la factura -->
    <div class="table-responsive" style="max-height:280px; overflow-y:auto;">
      <table class="table table-bordered table-sm align-middle text-center" id="tablaFactura">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Moneda</th>  <!-- Nueva columna -->
            <th>Total</th>
            <th>I.V.</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="listaProductosFactura"></tbody>
      </table>
    </div>

    <!-- Sección de totales con cálculo automático -->
    <div class="row justify-content-end mt-3">
      <div class="col-md-4">
        <table class="table table-borderless table-sm text-end">
          <tr>
            <td><strong>Subtotal:</strong></td>
            <td><input type="text" id="subtotal" class="form-control form-control-sm text-end fw-bold" value="0.00" readonly></td>
          </tr>
          <tr>
            <td><strong>Descuento:</strong></td>
            <td><input type="number" name="descuento" id="descuento" class="form-control form-control-sm text-end" value="0" min="0" step="0.01"></td>
          </tr>
          <tr>
            <td><strong>Subtotal Desc.:</strong></td>
            <td><input type="text" id="subtotalDesc" class="form-control form-control-sm text-end fw-bold" value="0.00" readonly></td>
          </tr>
          <tr>
            <td><strong>I.V.:</strong></td>
            <td><input type="text" id="ivaTotal" class="form-control form-control-sm text-end fw-bold" value="0.00" readonly></td>
          </tr>
          <tr>
            <td><strong>Total:</strong></td>
            <td>
              <input type="text" id="totalFinal" class="form-control form-control-sm text-end fw-bold text-primary" value="0.00" readonly>
              <input type="hidden" name="total" id="totalHidden" value="0.00">
            </td>
          </tr>
        </table>
      </div>
    </div>
  </form>
</div>

<!-- Scripts de jQuery y Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- Stripe.js - IMPORTANTE: Reemplaza 'pk_test_tu_llave_publica' con tu API key real -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('pk_test_tu_llave_publica'); // REEMPLAZA CON TU LLAVE REAL
  let elements;
  let cardElement;
  let clientSecret;

  // Script principal con toda la lógica de facturación
  // Constantes y variables globales
  const TASA_IVA = 0.15;
  let productosFactura = [];
  let productosModal = null;
  let pagoModal = null;
  let timeoutEscaneo = null;

  // Función para mostrar el modal de pago
  function mostrarModalPago() {
      if (productosFactura.length === 0) {
          alert('Debe agregar al menos un producto');
          return;
      }
    // Validar moneda de la factura
    const monedaInfo = getMonedaFactura();
    if (!monedaInfo) {
      alert('Los productos contienen diferentes monedas. No se puede procesar el pago. Por favor, ajuste la selección de productos.');
      return;
    }

    // Actualizar los valores en el modal usando la moneda y símbolo correctos
    const simbolo = monedaInfo.simbolo || '';
    document.getElementById('modal-subtotal').textContent = formatWithMoneda(parseFloat(document.getElementById('subtotal').value).toFixed(2), simbolo, monedaInfo.codigo);
    document.getElementById('modal-descuento').textContent = formatWithMoneda(parseFloat(document.getElementById('descuento').value || 0).toFixed(2), simbolo, monedaInfo.codigo);
    document.getElementById('modal-iva').textContent = formatWithMoneda(parseFloat(document.getElementById('ivaTotal').value).toFixed(2), simbolo, monedaInfo.codigo);
    document.getElementById('modal-total').textContent = formatWithMoneda(parseFloat(document.getElementById('totalFinal').value).toFixed(2), simbolo, monedaInfo.codigo);

    // Actualizar labels del modal para reflejar la moneda
    actualizarModalMoneda(monedaInfo);
      
      // Resetear campos de pago
      document.getElementById('monto-recibido').value = '';
      document.getElementById('vuelto').textContent = '$0.00';
      document.getElementById('vuelto').style.color = '#28a745';
      
      // Resetear método de pago a efectivo por defecto
      document.getElementById('metodoPago').value = 'efectivo';
      cambiarMetodoPago();
      
      // Mostrar el modal
      pagoModal.show();
      document.getElementById('monto-recibido').focus();
  }

  // Devuelve la moneda si todos los productos comparten la misma moneda, o null si hay mezcla
  function getMonedaFactura() {
    if (productosFactura.length === 0) return null;
    const monedas = new Set(productosFactura.map(p => p.moneda));
    const simbolos = new Set(productosFactura.map(p => p.monedaSimbolo));
    if (monedas.size === 1) {
      return { codigo: Array.from(monedas)[0], simbolo: Array.from(simbolos)[0] || '' };
    }
    return null; // mezcla de monedas
  }

  // Formatea un valor con el símbolo o código de moneda según disponibilidad
  function formatWithMoneda(valor, simbolo, codigo) {
    if (!isNaN(parseFloat(valor))) {
      // Mostrar símbolo si existe, sino mostrar código antes del monto
      return (simbolo ? simbolo + valor : codigo + ' ' + valor);
    }
    return valor;
  }

  // Actualiza textos y placeholders del modal de pago según la moneda
  function actualizarModalMoneda(monedaInfo) {
    const labelMonto = document.getElementById('label-monto-recibido');
    const montoInput = document.getElementById('monto-recibido');
    const vueltoEl = document.getElementById('vuelto');

    const simbolo = monedaInfo.simbolo || '';
    const codigo = monedaInfo.codigo || '';

    // Actualizar label
    labelMonto.textContent = `Monto Recibido ${simbolo || '(' + codigo + ')'}`;

    // Actualizar placeholder y current vuelto text
    montoInput.placeholder = '0.00';
    // Actualizar valores ya calculados en el modal
    const total = parseFloat(document.getElementById('totalFinal').value) || 0;
    const monto = parseFloat(montoInput.value) || 0;
    const vuelto = monto - total;
    if (montoInput.value === '') {
      vueltoEl.textContent = formatWithMoneda((0).toFixed(2), simbolo, codigo);
    } else if (vuelto >= 0) {
      vueltoEl.textContent = formatWithMoneda(vuelto.toFixed(2), simbolo, codigo);
    } else {
      vueltoEl.textContent = formatWithMoneda(Math.abs(vuelto).toFixed(2), simbolo, codigo) + ' (Falta)';
    }
  }

  // Función para cambiar entre métodos de pago
  function cambiarMetodoPago() {
      const metodo = document.getElementById('metodoPago').value;
      document.getElementById('panelEfectivo').style.display = metodo === 'efectivo' ? 'block' : 'none';
      document.getElementById('panelTarjeta').style.display = metodo === 'tarjeta' ? 'block' : 'none';
      document.getElementById('panelCredito').style.display = metodo === 'credito' ? 'block' : 'none';
      if (metodo === 'tarjeta' && !cardElement) {
          inicializarStripe();
      }
  }

  // Inicializar elementos de Stripe
  function inicializarStripe() {
      elements = stripe.elements();
      
      // Estilo para el elemento de la tarjeta
      const style = {
          base: {
              fontSize: '16px',
              color: '#32325d',
              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
              fontSmoothing: 'antialiased',
              '::placeholder': {
                  color: '#aab7c4'
              }
          },
          invalid: {
              color: '#fa755a',
              iconColor: '#fa755a'
          }
      };
      
      // Crear elemento de tarjeta
      cardElement = elements.create('card', { style: style });
      cardElement.mount('#card-element');
      
      // Manejar errores de la tarjeta
      cardElement.on('change', function(event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
              displayError.textContent = event.error.message;
              displayError.style.display = 'block';
          } else {
              displayError.textContent = '';
              displayError.style.display = 'none';
          }
      });
  }

  // Función para crear intento de pago con Stripe
  async function crearPagoStripe() {
    const total = parseFloat(document.getElementById('totalFinal').value) || 0;
    const monedaInfo = getMonedaFactura();
    const currency = monedaInfo ? monedaInfo.codigo.toLowerCase() : (document.getElementById('monedaHidden').value || 'usd');

    try {
      const response = await fetch('/facturas/crear-pago-tarjeta/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          monto: total,
          currency: currency
        })
      });

      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      return data.clientSecret;

    } catch (error) {
      document.getElementById('card-errors').textContent = 'Error al crear pago: ' + error.message;
      document.getElementById('card-errors').style.display = 'block';
      return null;
    }
  }

  // Función para procesar pago con tarjeta
  async function procesarPagoTarjeta() {
      // Mostrar loading
      const btn = document.getElementById('btn-procesar-pago');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Procesando...';
      btn.disabled = true;
      
      try {
          // Obtener client secret
          clientSecret = await crearPagoStripe();
          if (!clientSecret) return;
          
          // Confirmar el pago
          const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
              payment_method: {
                  card: cardElement,
                  billing_details: {
                      name: document.querySelector('select[name="cliente"] option:checked').textContent || 'Cliente',
                  }
              }
          });
          
          if (error) {
              throw new Error(error.message);
          }
          
          // Pago exitoso
          document.getElementById('id_transaccion').value = paymentIntent.id;
          document.getElementById('metodo_pago').value = 'tarjeta';
          document.getElementById('estado_pago').value = 'completado';
          document.getElementById('ultimos_digitos').value = paymentIntent.card.last4;
          document.getElementById('tipo_tarjeta').value = paymentIntent.card.brand;
          
          // Confirmar la factura
          confirmarFactura();
          
      } catch (error) {
          document.getElementById('card-errors').textContent = error.message;
          document.getElementById('card-errors').style.display = 'block';
      } finally {
          // Restaurar botón
          btn.innerHTML = originalText;
          btn.disabled = false;
      }
  }

  // Función para confirmar y enviar la factura
  function confirmarFactura() {
    // Antes de enviar, poblar el campo monedaHidden si corresponde
    const monedaInfo = getMonedaFactura();
    if (monedaInfo) {
      document.getElementById('monedaHidden').value = monedaInfo.codigo;
    }
    document.getElementById('confirmado').value = "true";
    document.getElementById('facturaForm').submit();
  }

  // Función para agregar productos desde cualquier fuente
  function agregarProductoAFactura(tr) {
      const id = tr.dataset.id;
      const productoExistente = productosFactura.find(p => p.id === id);
      
      if (productoExistente) {
          if (productoExistente.cantidad < productoExistente.stock) {
              productoExistente.cantidad += 1;
          } else {
              alert('No hay suficiente stock disponible');
              return;
          }
      } else {
          const tieneIvaPorDefecto = true;
          productosFactura.push({
              id: id,
              nombre: tr.dataset.nombre,
              precio: parseFloat(tr.dataset.precio),
              moneda: tr.dataset.moneda,  // Nuevo campo
              monedaSimbolo: tr.dataset.monedaSimbolo,  // Símbolo de la moneda
              cantidad: 1,
              stock: parseInt(tr.dataset.stock),
              iva: tieneIvaPorDefecto 
          });
      }
      renderizarTabla();
      document.getElementById('codigoEscaneado').focus();
  }

  // Función para cerrar el modal y limpiar
  function cerrarModal() {
      if (productosModal) {
          productosModal.hide();
          setTimeout(() => {
              const backdrops = document.querySelectorAll('.modal-backdrop');
              backdrops.forEach(backdrop => backdrop.remove());
              document.body.classList.remove('modal-open');
          }, 100);
          document.getElementById('buscarProducto').value = '';
          document.querySelectorAll('#listaProductos tr').forEach(tr => tr.style.display = '');
      }
  }

  // Función principal que actualiza la interfaz
  function renderizarTabla() {
      const tbody = document.getElementById('listaProductosFactura');
      tbody.innerHTML = '';
      
      let subtotal = 0, ivaTotal = 0;
      
    productosFactura.forEach(p => {
          const totalItem = p.precio * p.cantidad;
          subtotal += totalItem;
          const ivaItem = p.iva ? totalItem * TASA_IVA : 0;
          ivaTotal += ivaItem;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
              <td>${p.id}</td>
              <td class="text-start">${p.nombre}</td>
              <td><input type="number" min="1" max="${p.stock}" value="${p.cantidad}" 
                    class="form-control form-control-sm cantidad" 
                    onchange="actualizarCantidad('${p.id}', this.value)"></td>
        <td class="text-end">${p.monedaSimbolo}${p.precio.toFixed(2)}</td>
              <td class="text-center">
                  <span class="badge ${p.moneda === 'USD' ? 'bg-success' : 'bg-info'}">
                      ${p.moneda}
                  </span>
              </td>
        <td class="text-end">${p.monedaSimbolo}${totalItem.toFixed(2)}</td>
              <td class="text-center">
                  <input type="checkbox" ${p.iva ? 'checked' : ''} 
                         onchange="actualizarIva('${p.id}', this.checked)"
                         class="form-check-input">
              </td>
              <td><button onclick="eliminarProducto('${p.id}')" class="btn btn-danger btn-sm">Borrar</button></td>
          `;
          tbody.appendChild(tr);
      });
      
  const descuento = parseFloat(document.getElementById('descuento').value) || 0;
      const subtotalDesc = Math.max(0, subtotal - descuento);
      const total = subtotalDesc + ivaTotal;
      
    document.getElementById('subtotal').value = subtotal.toFixed(2);
    document.getElementById('subtotalDesc').value = subtotalDesc.toFixed(2);
    document.getElementById('ivaTotal').value = ivaTotal.toFixed(2);
    document.getElementById('totalFinal').value = total.toFixed(2);
      document.getElementById('totalHidden').value = total.toFixed(2);
      document.getElementById('productosJson').value = JSON.stringify(productosFactura);
  }

  // Funciones auxiliares para manejo de productos
  function actualizarCantidad(id, cantidad) {
      const producto = productosFactura.find(p => p.id === id);
      if (producto) {
          producto.cantidad = Math.min(parseInt(cantidad), producto.stock);
          renderizarTabla();
      }
  }

  function eliminarProducto(id) { 
      productosFactura = productosFactura.filter(p => p.id !== id); 
      renderizarTabla(); 
  }

  function borrarSeleccionados() { 
      if (confirm('¿Borrar todos los productos?')) { 
          productosFactura = []; 
          renderizarTabla(); 
      } 
  }

  function cancelarFactura() { 
      if (confirm('¿Cancelar factura actual?')) { 
          window.location.reload(); 
      } 
  }

  // Nueva función para actualizar IVA
  function actualizarIva(id, tieneIva) {
      const producto = productosFactura.find(p => p.id === id);
      if (producto) {
          producto.iva = tieneIva;
          renderizarTabla();
      }
  }

  // FUNCIÓN CORREGIDA: Buscador mejorado que funciona con ID, código QR, código de barras o nombre
  function buscarProductoPorIdentificador(valor) {
      // Buscar en todos los productos del modal
      const productos = document.querySelectorAll('#listaProductos tr');
      
      for (let producto of productos) {
        // Buscar por ID
        if (producto.querySelector('td:first-child').textContent === valor) {
          return producto;
        }
        
        // Buscar por código de barras (de la columna o del data-barra)
        const codigoBarraColumna = producto.querySelector('td:nth-child(7)').textContent.trim();
        if (codigoBarraColumna === valor) {
          return producto;
        }
        
        // Buscar por código de barras en data attribute
        if (producto.dataset.barra === valor) {
          return producto;
        }
        
        // Buscar por código QR
        if (producto.dataset.codigo === valor) {
          return producto;
        }
        
        // Buscar por nombre (búsqueda parcial, case insensitive)
        const nombre = producto.querySelector('td:nth-child(2)').textContent.toLowerCase();
        if (nombre.includes(valor.toLowerCase())) {
          return producto;
        }
        
        // Buscar por código de moneda
        const moneda = producto.querySelector('td:nth-child(4)').textContent.trim();
        if (moneda === valor.toUpperCase()) {
          return producto;
        }
      }
      
      return null; // No se encontró ningún producto
  }

  // Inicialización cuando el DOM está listo
  document.addEventListener('DOMContentLoaded', function() {
    productosModal = new bootstrap.Modal(document.getElementById('modalProductos'));
    pagoModal = new bootstrap.Modal(document.getElementById('modalPago'));
    
    // Reloj en tiempo real
    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString(), 1000);
    
    // Búsqueda en modal de productos
    document.getElementById('buscarProducto').addEventListener('input', function() {
        const busqueda = this.value.toLowerCase();
        document.querySelectorAll('#listaProductos tr').forEach(tr => {
            tr.style.display = tr.textContent.toLowerCase().includes(busqueda) ? '' : 'none';
        });
    });
    
    // Detección de entrada manual o QR (con timeout y Enter) - CORREGIDO
    const inputEscaneado = document.getElementById('codigoEscaneado');
    inputEscaneado.addEventListener('input', function() {
        clearTimeout(timeoutEscaneo);
        timeoutEscaneo = setTimeout(() => {
            const valor = this.value.trim();
            if (valor) {
                const producto = buscarProductoPorIdentificador(valor);
                if (producto) { 
                    agregarProductoAFactura(producto); 
                    this.value = ''; 
                } else {
                    alert('Producto no encontrado. Intente con ID, código de barras o nombre.');
                }
            }
        }, 1000);
    });
    
    inputEscaneado.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const valor = this.value.trim();
            if (valor) {
                const producto = buscarProductoPorIdentificador(valor);
                if (producto) { 
                    agregarProductoAFactura(producto); 
                    this.value = ''; 
                } else {
                    alert('Producto no encontrado. Intente con ID, código de barras o nombre.');
                }
            }
        }
    });
    
    // Delegación de eventos para botones Agregar en modal
    document.getElementById('listaProductos').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-agregar')) {
            agregarProductoAFactura(e.target.closest('tr'));
            cerrarModal();
        }
    });
    
    // Actualización al cambiar descuento
    document.getElementById('descuento').addEventListener('change', renderizarTabla);
    
    // Validación al enviar formulario
    document.getElementById('facturaForm').addEventListener('submit', function(e) {
        if (document.getElementById('confirmado').value !== "true") {
            e.preventDefault();
        } else if (productosFactura.length === 0) { 
            e.preventDefault(); 
            alert('Debe agregar al menos un producto'); 
        }
    });
    
    // Lógica para el modal de pago
  const montoRecibido = document.getElementById('monto-recibido');
  const vueltoElement = document.getElementById('vuelto');
    
  montoRecibido.addEventListener('input', function() {
    const total = parseFloat(document.getElementById('totalFinal').value) || 0;
    const monto = parseFloat(montoRecibido.value) || 0;
    const vuelto = monto - total;
    const monedaInfo = getMonedaFactura();
    const simbolo = monedaInfo ? monedaInfo.simbolo : '$';
    const codigo = monedaInfo ? monedaInfo.codigo : '';
        
    if (vuelto >= 0) {
      vueltoElement.textContent = formatWithMoneda(vuelto.toFixed(2), simbolo, codigo);
      vueltoElement.style.color = '#28a745';
    } else {
      vueltoElement.textContent = formatWithMoneda(Math.abs(vuelto).toFixed(2), simbolo, codigo) + ' (Falta)';
      vueltoElement.style.color = '#dc3545';
    }
  });
    
  document.getElementById('btn-procesar-pago').addEventListener('click', function() {
    const metodo = document.getElementById('metodoPago').value;
    const monedaInfo = getMonedaFactura();
    if (!monedaInfo) {
      alert('No se puede procesar el pago: hay productos con monedas diferentes en la factura.');
      return;
    }
    const simbolo = monedaInfo.simbolo || '';
    const codigo = monedaInfo.codigo || '';
        
    if (metodo === 'efectivo') {
      // Lógica existente para efectivo
      const total = parseFloat(document.getElementById('totalFinal').value) || 0;
      const monto = parseFloat(document.getElementById('monto-recibido').value) || 0;
            
      if (monto < total) {
        alert('El monto recibido es menor que el total a pagar.');
        return;
      }
            
      document.getElementById('montoRecibidoHidden').value = monto.toFixed(2);
      document.getElementById('vueltoHidden').value = (monto - total).toFixed(2);
      document.getElementById('metodo_pago').value = 'efectivo';
      document.getElementById('estado_pago').value = 'completado';
      // Guardar la moneda en un campo hidden adicional si es necesario
      // (no existe uno aún en el form; podríamos añadirlo si el backend requiere)
      pagoModal.hide();
      confirmarFactura();
            
    } else if (metodo === 'tarjeta') {
      // Para tarjeta también aseguramos que la moneda sea la principal del sistema o compatible
      procesarPagoTarjeta();
    } else if (metodo === 'credito') {
      document.getElementById('metodo_pago').value = 'credito';
      document.getElementById('estado_pago').value = 'pendiente';
      document.getElementById('confirmado').value = "true";
      pagoModal.hide();
      confirmarFactura();
    }
  });
    
    // Atajos de teclado (F5-F8)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F5') { e.preventDefault(); productosModal.show(); }
        if (e.key === 'F6') { e.preventDefault(); borrarSeleccionados(); }
        if (e.key === 'F7') { e.preventDefault(); mostrarModalPago(); }
        if (e.key === 'F8') { e.preventDefault(); cancelarFactura(); }
    });
  });
</script>

<!-- Estilos personalizados para la interfaz -->
<style>
  .table-responsive { max-height: 280px; overflow-y: auto; }
  input[type="number"] { text-align: right; }
  .text-end { text-align: right !important; }
  #codigoEscaneado { font-size: 1.2rem; padding: 10px; padding-right: 120px; }
  .modal-backdrop { z-index: 1040 !important; }
  body.modal-open { overflow: auto; padding-right: 0 !important; }
  .payment-display {
      font-size: 1.2rem;
      font-weight: bold;
      color: #28a745;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #f8f9fa;
  }
  .StripeElement {
      box-sizing: border-box;
      height: 40px;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background-color: white;
  }
  .StripeElement--focus { box-shadow: 0 0 0 3px #bfdbfe; }
  .StripeElement--invalid { border-color: #fa755a; }
  .StripeElement--webkit-autofill { background-color: #fefde5 !important; }
</style>
{% endblock %}