{% extends 'core/base.html' %}
{% load static %}
{% block title %}{% if form.instance.id %}Editar{% else %}Nuevo{% endif %} Producto{% endblock %}

{% block content %}
<h2>{% if form.instance.id %}Editar{% else %}Nuevo{% endif %} Producto</h2>
<a href="javascript:history.back()" class="btn btn-secondary mb-3">‚¨Ö Volver</a>

<!-- Mensajes de confirmaci√≥n -->
{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="ingresoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                            <i class="fas fa-keyboard me-2"></i>Ingreso Manual
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan" type="button" role="tab">
                            <i class="fas fa-qrcode me-2"></i>Escanear C√≥digo
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="ingresoTabsContent">
                    <!-- Formulario Manual -->
                    <div class="tab-pane fade show active" id="manual" role="tabpanel">
                        <form method="post" id="productForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label for="id_categoria" class="form-label">Categor√≠a *</label>
                                {{ form.categoria }}
                                {% if form.categoria.errors %}
                                <div class="text-danger">{{ form.categoria.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_nombre" class="form-label">Nombre del Producto *</label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                <div class="text-danger">{{ form.nombre.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_precio" class="form-label">Precio *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.precio }}
                                    </div>
                                    {% if form.precio.errors %}
                                    <div class="text-danger">{{ form.precio.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="id_stock" class="form-label">Stock *</label>
                                    {{ form.stock }}
                                    {% if form.stock.errors %}
                                    <div class="text-danger">{{ form.stock.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_codigo_qr" class="form-label">C√≥digo QR</label>
                                {{ form.codigo_qr }}
                                {% if form.codigo_qr.errors %}
                                <div class="text-danger">{{ form.codigo_qr.errors }}</div>
                                {% endif %}
                                <div class="form-text">Dejar vac√≠o para generar autom√°ticamente</div>
                            </div>
                            
                            <!-- Campo para c√≥digos de barras -->
                            <div class="mb-3">
                                <label class="form-label">C√≥digos de Barras</label>
                                <div id="barcodes-container">
                                    {% if form.instance.id %}
                                        {% for barcode in form.instance.barcodes.all %}
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" name="barcodes" value="{{ barcode.code }}" placeholder="C√≥digo de barras">
                                            <button type="button" class="btn btn-outline-danger remove-barcode">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" name="barcodes" placeholder="C√≥digo de barras">
                                        <button type="button" class="btn btn-outline-success add-barcode">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" id="generate-barcode" class="btn btn-outline-primary mt-2">
                                    <i class="fas fa-barcode me-2"></i>Generar C√≥digo de Barras
                                </button>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 mt-2">
                                <i class="fas fa-save me-2"></i>Guardar Producto
                            </button>
                        </form>
                    </div>
                    
                    <!-- Esc√°ner -->
                    <div class="tab-pane fade" id="scan" role="tabpanel">
                        <div class="scanner-container">
                            <video id="qr-video"></video>
                            <div class="scanner-overlay"></div>
                            <div class="scanner-label">Enfoca el c√≥digo QR dentro del marco</div>
                        </div>
                        <div class="d-flex justify-content-center mb-4 mt-3">
                            <button id="startScanner" class="btn btn-success me-2">
                                <i class="fas fa-camera me-2"></i>Iniciar Esc√°ner
                            </button>
                            <button id="stopScanner" class="btn btn-danger" disabled>
                                <i class="fas fa-stop me-2"></i>Detener Esc√°ner
                            </button>
                        </div>
                        <div class="mt-3">
                            <label for="manualCodeInput" class="form-label">O ingresa el c√≥digo manualmente:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="manualCodeInput" placeholder="C√≥digo QR">
                                <button class="btn btn-outline-primary" type="button" id="addByManualCode">
                                    <i class="fas fa-check me-1"></i>Usar este c√≥digo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header text-center">
                <i class="fas fa-info-circle me-2"></i>Informaci√≥n del Sistema
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h5>Escaneo de C√≥digos QR</h5>
                    <p class="text-muted">Usa la c√°mara para escanear c√≥digos QR y completar autom√°ticamente el campo de c√≥digo</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header text-center">
                <i class="fas fa-lightbulb me-2"></i>Sugerencias
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">Aseg√∫rate de tener buena iluminaci√≥n al escanear</li>
                    <li class="list-group-item">Mant√©n estable el dispositivo durante el escaneo</li>
                    <li class="list-group-item">Verifica que el c√≥digo escaneado sea correcto</li>
                </ul>
            </div>
        </div>
        
        <!-- Vista previa del c√≥digo de barras -->
        <div class="card mt-4" id="barcode-preview-container" style="display: none;">
            <div class="card-header text-center">
                <i class="fas fa-barcode me-2"></i>Vista Previa C√≥digo de Barras
            </div>
            <div class="card-body text-center">
                <canvas id="barcode-preview" width="200" height="100"></canvas>
                <p class="mt-2 text-muted small" id="barcode-value"></p>
                <button class="btn btn-sm btn-outline-success mt-2" id="use-barcode-btn">
                    <i class="fas fa-check me-1"></i>Usar este c√≥digo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos para el esc√°ner -->
<style>
    .scanner-container {
        position: relative;
        width: 100%;
        height: 300px;
        overflow: hidden;
        border-radius: 12px;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1.5rem;
        border: 2px dashed #ccc;
    }
    
    #qr-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .scanner-overlay {
        position: absolute;
        width: 80%;
        height: 200px;
        border: 3px solid #fff;
        box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
        border-radius: 12px;
    }
    
    .scanner-label {
        position: absolute;
        bottom: 10px;
        color: white;
        font-weight: 500;
        text-align: center;
        width: 100%;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }
    
    .feature-icon {
        font-size: 2.5rem;
        color: #4361ee;
        background: linear-gradient(135deg, #4361ee, #7209b7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #495057;
        font-weight: 500;
        padding: 0.8rem 1.2rem;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom: 3px solid #4361ee;
        color: #4361ee;
        background: transparent;
    }
    
    /* Estilos para vista previa de c√≥digo de barras */
    #barcode-preview {
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 10px;
        background: white;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== SISTEMA DE ESC√ÅNER - DETECCI√ìN DE C√ÅMARAS ===');
        
        // Variables globales
        let scannerActive = false;
        let stream = null;
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('startScanner');
        const stopBtn = document.getElementById('stopScanner');
        
        // Verificar compatibilidad
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('‚ùå API de c√°mara no disponible');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-times me-2"></i>No compatible';
            showNotification('Navegador no compatible con c√°mara', 'danger');
            return;
        }
        
        console.log('‚úÖ API de c√°mara disponible');
        
        // EVENTO INICIAR ESC√ÅNER - VERSI√ìN ROBUSTA
        startBtn.addEventListener('click', async function() {
            console.log('üé¨ Intentando iniciar c√°mara...');
            
            try {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Conectando...';
                
                // Detener stream anterior si existe
                if (stream) {
                    stopScanner();
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // INTENTAR DIFERENTES CONFIGURACIONES DE C√ÅMARA
                const cameraConfigs = [
                    // Configuraci√≥n 1: C√°mara trasera (environment)
                    {
                        video: {
                            facingMode: "environment",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    // Configuraci√≥n 2: C√°mara frontal (user)
                    {
                        video: {
                            facingMode: "user",
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    // Configuraci√≥n 3: Cualquier c√°mara
                    {
                        video: true
                    },
                    // Configuraci√≥n 4: Resoluci√≥n baja
                    {
                        video: {
                            width: { min: 640, ideal: 640, max: 640 },
                            height: { min: 480, ideal: 480, max: 480 }
                        }
                    }
                ];
                
                let cameraConnected = false;
                
                // Probar cada configuraci√≥n hasta que una funcione
                for (let i = 0; i < cameraConfigs.length; i++) {
                    try {
                        console.log(`üì∑ Probando configuraci√≥n ${i + 1}...`);
                        showNotification(`Probando c√°mara ${i + 1}/${cameraConfigs.length}`, 'info');
                        
                        stream = await navigator.mediaDevices.getUserMedia(cameraConfigs[i]);
                        cameraConnected = true;
                        console.log(`‚úÖ Configuraci√≥n ${i + 1} exitosa`);
                        break;
                        
                    } catch (error) {
                        console.warn(`‚ùå Configuraci√≥n ${i + 1} fall√≥:`, error.message);
                        // Continuar con la siguiente configuraci√≥n
                    }
                }
                
                if (!cameraConnected) {
                    throw new Error('No se pudo conectar con ninguna c√°mara');
                }
                
                // CONFIGURAR VIDEO
                video.srcObject = stream;
                video.playsInline = true;
                
                // Esperar a que el video est√© listo
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = resolve;
                    video.onerror = reject;
                    setTimeout(reject, 5000); // Timeout de 5 segundos
                });
                
                console.log('üé• Metadata del video cargada');
                
                // INICIAR REPRODUCCI√ìN
                try {
                    await video.play();
                    console.log('‚úÖ Video reproduci√©ndose');
                    
                    scannerActive = true;
                    startBtn.innerHTML = '<i class="fas fa-camera me-2"></i>Escaneando...';
                    
                    // Iniciar detecci√≥n
                    startQRDetection();
                    showNotification('C√°mara activada - Escaneando QR', 'success');
                    
                } catch (playError) {
                    console.error('‚ùå Error al reproducir video:', playError);
                    throw new Error('No se pudo reproducir el video');
                }
                
            } catch (error) {
                console.error('‚ùå ERROR CR√çTICO:', error);
                
                let errorMessage = 'Error al conectar con la c√°mara';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso de c√°mara denegado. Por favor permite el acceso.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontr√≥ ninguna c√°mara conectada.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'La c√°mara est√° siendo usada por otra aplicaci√≥n.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'No se pudo configurar la c√°mara.';
                }
                
                showNotification(errorMessage, 'danger');
                stopScanner();
            }
        });
        
        // DETENER ESC√ÅNER
        stopBtn.addEventListener('click', function() {
            console.log('‚èπÔ∏è Deteniendo esc√°ner por usuario');
            stopScanner();
        });
        
        // DETECCI√ìN DE QR
        function startQRDetection() {
            if (!scannerActive) return;
            
            console.log('üîç Iniciando detecci√≥n QR...');
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let frameCount = 0;
            
            const scanFrame = () => {
                if (!scannerActive) return;
                
                try {
                    frameCount++;
                    
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, canvas.width, canvas.height, {
                            inversionAttempts: "dontInvert",
                        });
                        
                        if (code) {
                            console.log('‚úÖ QR DETECTADO:', code.data);
                            handleScannedCode(code.data);
                            return;
                        }
                        
                        // Log cada 30 frames
                        if (frameCount % 30 === 0) {
                            console.log('üìä Escaneando frame', frameCount);
                        }
                    }
                } catch (error) {
                    console.error('Error en escaneo:', error);
                }
                
                if (scannerActive) {
                    requestAnimationFrame(scanFrame);
                }
            };
            
            scanFrame();
        }
        
        // MANEJAR C√ìDIGO DETECTADO
        function handleScannedCode(code) {
            console.log('üíæ Guardando c√≥digo:', code);
            stopScanner();
            
            // Llenar campo de c√≥digo
            const codeField = document.getElementById('id_codigo_qr');
            if (codeField) {
                codeField.value = code;
                
                // Efecto visual
                codeField.style.border = '2px solid #28a745';
                codeField.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                setTimeout(() => {
                    codeField.style.border = '';
                    codeField.style.boxShadow = '';
                }, 2000);
            }
            
            // Cambiar a pesta√±a manual
            switchToManualTab();
            showNotification('‚úÖ C√≥digo capturado: ' + code, 'success');
        }
        
        // CAMBIAR A PESTA√ëA MANUAL
        function switchToManualTab() {
            try {
                const manualTab = document.getElementById('manual-tab');
                if (manualTab) {
                    const tab = new bootstrap.Tab(manualTab);
                    tab.show();
                }
                
                setTimeout(() => {
                    const nombreField = document.getElementById('id_nombre');
                    if (nombreField) nombreField.focus();
                }, 300);
                
            } catch (error) {
                console.warn('Error al cambiar pesta√±a:', error);
            }
        }
        
        // DETENER ESC√ÅNER COMPLETAMENTE
        function stopScanner() {
            console.log('üõë Deteniendo esc√°ner...');
            scannerActive = false;
            
            // Detener stream
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
                stream = null;
            }
            
            // Limpiar video
            if (video.srcObject) {
                video.srcObject = null;
            }
            
            video.pause();
            
            // Restablecer botones
            startBtn.disabled = false;
            stopBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-camera me-2"></i>Iniciar Esc√°ner';
            
            console.log('‚úÖ Esc√°ner completamente detenido');
        }
        
        // BOT√ìN DE C√ìDIGO MANUAL
        document.getElementById('addByManualCode').addEventListener('click', function() {
            const input = document.getElementById('manualCodeInput');
            const code = input.value.trim();
            
            if (!code) {
                showNotification('‚ö†Ô∏è Ingresa un c√≥digo primero', 'warning');
                return;
            }
            
            const codeField = document.getElementById('id_codigo_qr');
            if (codeField) {
                codeField.value = code;
            }
            
            switchToManualTab();
            input.value = '';
            showNotification('‚úÖ C√≥digo manual asignado', 'info');
        });
        
        // NOTIFICACIONES
        function showNotification(message, type) {
            // Limpiar notificaciones anteriores
            document.querySelectorAll('.scan-notification').forEach(el => el.remove());
            
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show scan-notification`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                font-weight: bold;
            `;
            
            notification.innerHTML = `
                ${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'} 
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // TESTEO DE C√ÅMARA AL CARGAR
        console.log('üîÑ Verificando disponibilidad de c√°maras...');
        checkCameraAvailability();
        
        async function checkCameraAvailability() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log('üìã C√°maras disponibles:', videoDevices.length);
                
                if (videoDevices.length === 0) {
                    console.warn('‚ö†Ô∏è No se detectaron c√°maras');
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-times me-2"></i>Sin c√°mara';
                    showNotification('No se detect√≥ ninguna c√°mara', 'warning');
                } else {
                    console.log('‚úÖ C√°maras detectadas:', videoDevices.map(d => d.label || 'C√°mara ' + d.deviceId));
                }
                
            } catch (error) {
                console.error('Error al verificar c√°maras:', error);
            }
        }
        
        // ==============================================
        // C√ìDIGOS DE BARRAS - FUNCIONALIDAD ADICIONAL
        // ==============================================
        
        // Agregar campo de c√≥digo de barras
        document.querySelector('.add-barcode').addEventListener('click', function() {
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <input type="text" class="form-control" name="barcodes" placeholder="C√≥digo de barras">
                <button type="button" class="btn btn-outline-danger remove-barcode">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            document.getElementById('barcodes-container').appendChild(newInput);
            
            // Agregar evento al nuevo bot√≥n de eliminar
            newInput.querySelector('.remove-barcode').addEventListener('click', function() {
                this.closest('.input-group').remove();
            });
        });
        
        // Eliminar campo de c√≥digo de barras
        document.querySelectorAll('.remove-barcode').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.input-group').remove();
            });
        });
        
        // Generar c√≥digo de barras
        document.getElementById('generate-barcode').addEventListener('click', function() {
            // Generar un c√≥digo aleatorio de 13 d√≠gitos (formato EAN-13)
            const randomCode = Math.floor(1000000000000 + Math.random() * 9000000000000).toString();
            
            // Mostrar vista previa
            const previewContainer = document.getElementById('barcode-preview-container');
            const canvas = document.getElementById('barcode-preview');
            const barcodeValue = document.getElementById('barcode-value');
            
            // Generar el c√≥digo de barras en el canvas
            JsBarcode(canvas, randomCode, {
                format: "EAN13",
                lineColor: "#000",
                width: 2,
                height: 40,
                displayValue: true
            });
            
            barcodeValue.textContent = randomCode;
            previewContainer.style.display = 'block';
            
            // Configurar bot√≥n para usar este c√≥digo
            document.getElementById('use-barcode-btn').onclick = function() {
                // Agregar el c√≥digo a la lista
                const newInput = document.createElement('div');
                newInput.className = 'input-group mb-2';
                newInput.innerHTML = `
                    <input type="text" class="form-control" name="barcodes" value="${randomCode}" placeholder="C√≥digo de barras">
                    <button type="button" class="btn btn-outline-danger remove-barcode">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                document.getElementById('barcodes-container').appendChild(newInput);
                
                // Agregar evento al nuevo bot√≥n de eliminar
                newInput.querySelector('.remove-barcode').addEventListener('click', function() {
                    this.closest('.input-group').remove();
                });
                
                // Ocultar vista previa
                previewContainer.style.display = 'none';
                
                showNotification('C√≥digo de barras agregado', 'success');
            };
        });
        
        console.log('‚úÖ Sistema de esc√°ner y c√≥digos de barras inicializado');
    });
</script>

<style>
    /* Mejoras visuales */
    #startScanner:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    #stopScanner:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .scanner-container {
        transition: all 0.3s ease;
    }
    
    .scanner-container.active {
        border: 3px solid #28a745 !important;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3) !important;
    }
    
    /* Spinner para carga */
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}